<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crispy Chicken | Professional Analytics</title>
<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
    /* Brand Colors */
    --primary: #dc2626; /* Crispy Red */
    --primary-dark: #991b1b;
    --primary-light: #fef2f2;
    
    /* Neutrals */
    --bg-body: #f3f4f6;
    --bg-card: #ffffff;
    --text-main: #1f2937;
    --text-muted: #6b7280;
    --border: #e5e7eb;
    
    /* Status Colors */
    --success: #10b981;
    --success-bg: #ecfdf5;
    --warning: #f59e0b;
    --warning-bg: #fffbeb;
    --danger: #ef4444;
    --danger-bg: #fef2f2;
    --info: #3b82f6;
    --info-bg: #eff6ff;

    /* Dimensions & Effects */
    --radius: 12px;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Inter', system-ui, sans-serif;
    background-color: var(--bg-body);
    color: var(--text-main);
    min-height: 100vh;
    padding-bottom: 40px;
}

.container { max-width: 1600px; margin: 0 auto; padding: 20px; }

/* --- Header --- */
header {
    background: var(--bg-card);
    padding: 20px 30px;
    border-radius: var(--radius);
    margin-bottom: 24px;
    box-shadow: var(--shadow);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
    border-bottom: 4px solid var(--primary);
}

.brand { display: flex; align-items: center; gap: 15px; }
.brand-logo {
    background: var(--primary); color: white; width: 45px; height: 45px;
    border-radius: 10px; display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem; box-shadow: var(--shadow);
}
h1 { font-size: 1.5rem; font-weight: 700; color: var(--text-main); letter-spacing: -0.025em; }
.header-meta { display: flex; align-items: center; gap: 20px; }
.date-badge {
    background: var(--bg-body); color: var(--text-muted); padding: 8px 16px;
    border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 8px;
}

/* --- Buttons --- */
.btn {
    padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer;
    font-weight: 600; font-size: 0.9rem; transition: var(--transition);
    display: inline-flex; align-items: center; gap: 8px;
}
.btn:active { transform: scale(0.98); }
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-dark); box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
.btn-outline:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
.btn-danger { background: var(--danger-bg); color: var(--danger); }
.btn-danger:hover { background: var(--danger); color: white; }
.btn-icon { padding: 8px; border-radius: 6px; }

/* --- Layout Grid --- */
.kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 24px; }
.dashboard-grid { display: grid; grid-template-columns: 320px 1fr; gap: 24px; margin-bottom: 24px; }
.charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px; }

/* --- Cards --- */
.card {
    background: var(--bg-card); border-radius: var(--radius);
    box-shadow: var(--shadow); padding: 24px; position: relative; overflow: hidden;
    transition: var(--transition);
}
.card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.card-title { font-size: 1.1rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 10px; }

/* --- KPIs --- */
.kpi-value { font-size: 1.8rem; font-weight: 800; margin: 8px 0; color: var(--text-main); }
.kpi-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
.kpi-trend { font-size: 0.85rem; margin-top: 4px; font-weight: 600; }
.trend-up { color: var(--success); }
.trend-down { color: var(--danger); }
.kpi-icon-bg { position: absolute; right: -10px; bottom: -10px; font-size: 5rem; opacity: 0.05; color: var(--text-main); transform: rotate(-15deg); }

/* --- Performance Section (Special) --- */
.perf-table th { background: var(--bg-body); color: var(--text-muted); font-weight: 600; font-size: 0.8rem; padding: 12px 15px; text-transform: uppercase; }
.perf-table td { padding: 15px; border-bottom: 1px solid var(--border); vertical-align: middle; }
.perf-table tr:last-child td { border-bottom: none; }
.rank-circle { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; }
.rank-1 { background: #fbbf24; color: white; box-shadow: 0 0 0 2px #fcd34d; }
.rank-2 { background: #9ca3af; color: white; }
.rank-3 { background: #b45309; color: white; }
.rank-other { background: var(--bg-body); color: var(--text-muted); }

.progress-wrapper { width: 100%; height: 6px; background: var(--bg-body); border-radius: 10px; margin-top: 8px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 10px; transition: width 1s ease-out; }

/* --- Forms --- */
.form-group { margin-bottom: 16px; }
.form-label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 6px; }
input, select {
    width: 100%; padding: 10px 12px; border: 1px solid var(--border);
    border-radius: 8px; font-size: 0.95rem; transition: var(--transition);
    font-family: inherit; background: #f9fafb;
}
input:focus, select:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1); }
.input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.auto-calc { background-color: var(--info-bg); border-color: var(--info); color: var(--info-dark); font-weight: 600; cursor: pointer; }

/* --- Data Table --- */
.table-container { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
table { width: 100%; border-collapse: collapse; min-width: 600px; }
thead th { background: var(--text-main); color: white; text-align: left; padding: 14px 16px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; }
tbody tr { border-bottom: 1px solid var(--border); transition: background 0.2s; }
tbody tr:hover { background: var(--bg-body); }
tbody td { padding: 14px 16px; font-size: 0.9rem; color: var(--text-main); vertical-align: middle; }
.action-btns { display: flex; gap: 6px; justify-content: flex-end; }

/* --- Badges --- */
.badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.badge-success { background: var(--success-bg); color: var(--success); }
.badge-warning { background: var(--warning-bg); color: var(--warning); }
.badge-danger { background: var(--danger-bg); color: var(--danger); }

/* --- Filters --- */
.filter-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: flex-end; }
#dateRangeWrapper { display: none; gap: 10px; flex: 2; animation: slideDown 0.3s ease; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

/* --- Modal --- */
.modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
    z-index: 100; display: flex; align-items: center; justify-content: center;
    opacity: 0; visibility: hidden; transition: var(--transition);
}
.modal-overlay.show { opacity: 1; visibility: visible; }
.modal-box {
    background: white; width: 90%; max-width: 500px; border-radius: var(--radius);
    padding: 30px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    transform: scale(0.95); transition: var(--transition);
}
.modal-overlay.show .modal-box { transform: scale(1); }

/* --- Toast --- */
.toast {
    position: fixed; bottom: 30px; right: 30px; z-index: 200;
    background: var(--text-main); color: white; padding: 12px 24px;
    border-radius: 8px; font-weight: 500; box-shadow: var(--shadow-lg);
    transform: translateY(100px); opacity: 0; transition: var(--transition);
    display: flex; align-items: center; gap: 10px;
}
.toast.show { transform: translateY(0); opacity: 1; }

/* --- Responsive --- */
@media (max-width: 1024px) {
    .dashboard-grid, .charts-grid { grid-template-columns: 1fr; }
    .header-meta { width: 100%; justify-content: space-between; margin-top: 15px; }
}
</style>
</head>
<body>

<div class="container">
    <!-- Header -->
    <header>
        <div class="brand">
            <div class="brand-logo"><i class="fas fa-drumstick-bite"></i></div>
            <h1>Crispy Chicken<br><span style="font-size:0.9rem; font-weight:400; color:var(--text-muted)">Performance Analytics</span></h1>
        </div>
        <div class="header-meta">
            <div class="date-badge"><i class="far fa-calendar-alt"></i> <span id="currentDate">Loading...</span></div>
            <button class="btn btn-outline" onclick="document.getElementById('csvFile').click()">
                <i class="fas fa-file-csv"></i> Import
            </button>
            <input type="file" id="csvFile" accept=".csv" hidden onchange="importCSV(this)">
            <button class="btn btn-outline" onclick="exportData()">
                <i class="fas fa-download"></i> Export
            </button>
            <button class="btn btn-primary" onclick="openModal()">
                <i class="fas fa-plus"></i> New Entry
            </button>
        </div>
    </header>

    <!-- KPI Section -->
    <section class="kpi-grid" id="kpiContainer">
        <!-- Rendered by JS -->
    </section>

    <!-- Charts Row -->
    <section class="charts-grid">
        <div class="card">
            <div class="card-header">
                <div class="card-title"><i class="fas fa-chart-line" style="color:var(--primary)"></i> Revenue Trend</div>
                <select id="trendDays" onchange="refreshDashboard()" style="width:auto; padding:6px 12px; font-size:0.85rem;">
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last Quarter</option>
                </select>
            </div>
            <div style="height:300px; position:relative;">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-title"><i class="fas fa-chart-pie" style="color:var(--info)"></i> Sales Mix</div>
            </div>
            <div style="height:300px; position:relative; display:flex; justify-content:center;">
                <canvas id="mixChart"></canvas>
            </div>
        </div>
    </section>

    <!-- Professional Performance Ranking -->
    <section class="card" style="margin-bottom: 24px;">
        <div class="card-header">
            <div class="card-title"><i class="fas fa-trophy" style="color:var(--warning)"></i> Branch Performance Leaderboard</div>
            <div style="font-size:0.85rem; color:var(--text-muted)">Based on selected filters</div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items:start;">
            <!-- Ranking Table -->
            <div class="table-container" style="border:none;">
                <table class="perf-table">
                    <thead>
                        <tr>
                            <th style="width:50px">#</th>
                            <th>Branch</th>
                            <th style="text-align:right">Target</th>
                            <th style="text-align:right">Actual</th>
                            <th style="width:120px">Achievement</th>
                        </tr>
                    </thead>
                    <tbody id="rankBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
            
            <!-- Performance Chart (Bar) -->
            <div style="height: 350px; position: relative;">
                <canvas id="perfChart"></canvas>
            </div>
        </div>
    </section>

    <main class="dashboard-grid">
        <!-- Quick Entry Panel -->
        <aside class="card">
            <div class="card-header">
                <div class="card-title"><i class="fas fa-bolt" style="color:var(--warning)"></i> Quick Entry</div>
            </div>
            <form id="quickForm" onsubmit="handleQuickSubmit(event)">
                <div class="form-group">
                    <label class="form-label">Branch</label>
                    <select id="q_branch" required onchange="calcTarget('q_branch', 'q_date', 'q_target')">
                        <option value="">Select Branch</option>
                        <option value="Crispy Chicken Hamdan">Hamdan St</option>
                        <option value="Crispy Chicken Shabiya">Shabiya 11</option>
                        <option value="Crispy Chicken Khaldia">Khaldia</option>
                        <option value="Crispy Chicken Muroor">Muroor</option>
                        <option value="Crispy Chicken Al Barsha">Al Barsha</option>
                        <option value="Crispy Chicken Al Satwa">Al Satwa</option>
                        <option value="Crispy Chicken ELctria">ELctria</option>
                        <option value="Crispy Chicken Al Rgga">Al Rgga</option>
                        <option value="Crispy Chicken Majaz">Majaz</option>
                        <option value="Crispy Chicken Call Center">Call Center</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" id="q_date" required onchange="calcTarget('q_branch', 'q_date', 'q_target')">
                </div>
                
                <div style="background:var(--bg-body); padding:12px; border-radius:8px; margin-bottom:15px;">
                    <label class="form-label" style="margin-bottom:10px; display:block;">Sales Channels</label>
                    <div class="input-row" style="margin-bottom:12px;">
                        <input type="number" id="q_delivery" placeholder="Delivery" step="0.01">
                        <input type="number" id="q_online" placeholder="Online" step="0.01">
                    </div>
                    <div class="input-row">
                        <input type="number" id="q_aggregator" placeholder="Aggregator" step="0.01">
                        <input type="number" id="q_dining" placeholder="Dining" step="0.01">
                    </div>
                </div>

                <div class="input-row">
                    <div class="form-group">
                        <label class="form-label">Transactions</label>
                        <input type="number" id="q_trans" min="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Daily Target</label>
                        <input type="number" id="q_target" class="auto-calc" placeholder="Auto" title="Calculated automatically">
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width:100%; justify-content:center; margin-top:10px;">
                    <i class="fas fa-save"></i> Save Record
                </button>
            </form>
        </aside>

        <!-- Data List Panel -->
        <section class="card">
            <div class="card-header">
                <div class="card-title"><i class="fas fa-list" style="color:var(--text-muted)"></i> Transaction History</div>
                <button class="btn btn-icon btn-danger" style="padding:6px 10px; font-size:0.75rem;" onclick="clearAllData()">
                    <i class="fas fa-trash"></i> Reset
                </button>
            </div>

            <div class="filter-bar">
                <div style="flex:1; min-width:180px;">
                    <label class="form-label">Filter Branch</label>
                    <select id="f_branch" onchange="refreshDashboard()"><option value="all">All Branches</option></select>
                </div>
                <div style="flex:1; min-width:150px;">
                    <label class="form-label">Period</label>
                    <select id="f_period" onchange="toggleDateRange(); refreshDashboard()">
                        <option value="today">Today</option>
                        <option value="week">Last 7 Days</option>
                        <option value="month" selected>Last 30 Days</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div id="dateRangeWrapper">
                    <div style="flex:1;"><input type="date" id="d_start" onchange="refreshDashboard()"></div>
                    <div style="flex:1;"><input type="date" id="d_end" onchange="refreshDashboard()"></div>
                </div>
            </div>

            <div class="table-container">
                <table id="mainTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Branch</th>
                            <th>Total Sales</th>
                            <th>Trans.</th>
                            <th>Ach %</th>
                            <th style="text-align:right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div id="emptyState" style="display:none; text-align:center; padding:40px; color:var(--text-muted);">
                <i class="fas fa-box-open" style="font-size:3rem; margin-bottom:15px; opacity:0.3;"></i>
                <p>No records found for this period.</p>
            </div>
        </section>
    </main>
</div>

<!-- Modal -->
<div class="modal-overlay" id="entryModal">
    <div class="modal-box">
        <div class="card-header" style="margin-bottom:20px;">
            <div class="card-title" id="modalTitle">Add Data</div>
            <button class="btn btn-icon" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <form id="modalForm" onsubmit="handleModalSubmit(event)">
            <input type="hidden" id="m_id">
            <div class="form-group">
                <label class="form-label">Branch</label>
                <select id="m_branch" required onchange="calcTarget('m_branch', 'm_date', 'm_target')">
                    <option value="">Select Branch</option>
                    <option value="Crispy Chicken Hamdan">Hamdan St</option>
                    <option value="Crispy Chicken Shabiya">Shabiya 11</option>
                    <option value="Crispy Chicken Khaldia">Khaldia</option>
                    <option value="Crispy Chicken Muroor">Muroor</option>
                    <option value="Crispy Chicken Al Barsha">Al Barsha</option>
                    <option value="Crispy Chicken Al Satwa">Al Satwa</option>
                    <option value="Crispy Chicken ELctria">ELctria</option>
                    <option value="Crispy Chicken Al Rgga">Al Rgga</option>
                    <option value="Crispy Chicken Majaz">Majaz</option>
                    <option value="Crispy Chicken Call Center">Call Center</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" id="m_date" required onchange="calcTarget('m_branch', 'm_date', 'm_target')">
            </div>
            <div class="input-row">
                <div class="form-group"><label class="form-label">Delivery</label><input type="number" id="m_delivery" step="0.01"></div>
                <div class="form-group"><label class="form-label">Online</label><input type="number" id="m_online" step="0.01"></div>
            </div>
            <div class="input-row">
                <div class="form-group"><label class="form-label">Aggregator</label><input type="number" id="m_aggregator" step="0.01"></div>
                <div class="form-group"><label class="form-label">Dining</label><input type="number" id="m_dining" step="0.01"></div>
            </div>
            <div class="input-row">
                <div class="form-group"><label class="form-label">Transactions</label><input type="number" id="m_trans"></div>
                <div class="form-group"><label class="form-label">Target</label><input type="number" id="m_target" class="auto-calc"></div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast"><i class="fas fa-check-circle"></i> <span id="toastMsg">Success</span></div>

<script>
// --- CONFIGURATION ---
const STORAGE_KEY = 'crispy_v2';
let salesData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let charts = {};

const BRANCH_TARGETS = {
    "Crispy Chicken Hamdan": 840000,
    "Crispy Chicken Shabiya": 800000,
    "Crispy Chicken Khaldia": 750000,
    "Crispy Chicken Muroor": 620000,
    "Crispy Chicken Al Barsha": 800000,
    "Crispy Chicken Al Satwa": 650000,
    "Crispy Chicken ELctria": 1000000,
    "Crispy Chicken Al Rgga": 815000,
    "Crispy Chicken Majaz": 400000,
    "Crispy Chicken Call Center": 265000
};

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('q_date').value = today;
    document.getElementById('m_date').value = today;
    document.getElementById('d_start').value = today;
    document.getElementById('d_end').value = today;
    
    updateDateDisplay();
    populateFilters();
    initCharts();
    refreshDashboard();
});

function updateDateDisplay() {
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
}

function populateFilters() {
    const sel = document.getElementById('f_branch');
    Object.keys(BRANCH_TARGETS).forEach(b => {
        const opt = document.createElement('option');
        opt.value = b;
        opt.textContent = b.replace('Crispy Chicken ', '');
        sel.appendChild(opt);
    });
}

function toggleDateRange() {
    const isCustom = document.getElementById('f_period').value === 'custom';
    document.getElementById('dateRangeWrapper').style.display = isCustom ? 'flex' : 'none';
}

// --- CORE FUNCTIONS ---

function getFilteredData() {
    const branch = document.getElementById('f_branch').value;
    const period = document.getElementById('f_period').value;
    const today = new Date(); today.setHours(0,0,0,0);
    
    return salesData.filter(item => {
        const d = new Date(item.date); d.setHours(0,0,0,0);
        let validDate = false;
        
        if(period === 'today') validDate = d.getTime() === today.getTime();
        else if(period === 'week') validDate = d >= new Date(today.setDate(today.getDate()-7));
        else if(period === 'month') validDate = d >= new Date(today.setDate(today.getDate()-30));
        else if(period === 'custom') {
            const start = new Date(document.getElementById('d_start').value);
            const end = new Date(document.getElementById('d_end').value);
            validDate = d >= start && d <= end;
        }
        
        return validDate && (branch === 'all' || item.branch === branch);
    }).sort((a,b) => new Date(b.date) - new Date(a.date));
}

function calcTarget(branchId, dateId, targetId) {
    const b = document.getElementById(branchId).value;
    const d = document.getElementById(dateId).value;
    const targetInput = document.getElementById(targetId);

    // Only calculate if user isn't currently typing in the target field
    if(document.activeElement !== targetInput && b && d) {
        const monthly = BRANCH_TARGETS[b] || 0;
        const daysInMonth = new Date(new Date(d).getFullYear(), new Date(d).getMonth() + 1, 0).getDate();
        targetInput.value = (monthly / daysInMonth).toFixed(2);
    }
}

function refreshDashboard() {
    const data = getFilteredData();
    renderKPIs(data);
    renderTable(data);
    renderLeaderboard(data);
    updateCharts(data);
    
    const tableEl = document.getElementById('mainTable');
    const emptyEl = document.getElementById('emptyState');
    tableEl.style.display = data.length ? 'table' : 'none';
    emptyEl.style.display = data.length ? 'none' : 'block';
}

// --- RENDERING UI ---

function renderKPIs(data) {
    const totalSales = data.reduce((acc, i) => acc + i.total, 0);
    const totalTarget = data.reduce((acc, i) => acc + i.target, 0);
    const totalTrans = data.reduce((acc, i) => acc + i.transactions, 0);
    const ach = totalTarget ? Math.round((totalSales/totalTarget)*100) : 0;
    
    // Calculate selected days for Call Center logic
    const days = getDaysInPeriod();
    const ccTarget = (265000 / 30) * days; // Approx monthly daily target
    const ccSales = data.reduce((acc, i) => acc + i.delivery, 0); // Aggregating delivery as proxy
    const ccAch = Math.round((ccSales/ccTarget)*100);

    const html = `
        <div class="card">
            <i class="fas fa-coins kpi-icon-bg"></i>
            <div class="kpi-label">Total Revenue</div>
            <div class="kpi-value">AED ${totalSales.toLocaleString()}</div>
            <div class="kpi-trend"><i class="fas fa-receipt"></i> ${totalTrans} Orders</div>
        </div>
        <div class="card">
            <i class="fas fa-bullseye kpi-icon-bg"></i>
            <div class="kpi-label">Overall Achievement</div>
            <div class="kpi-value" style="color:${ach >= 100 ? 'var(--success)' : 'var(--primary)'}">${ach}%</div>
            <div class="kpi-trend">Target: AED ${totalTarget.toLocaleString()}</div>
        </div>
        <div class="card">
            <i class="fas fa-headset kpi-icon-bg"></i>
            <div class="kpi-label">Call Center Perf.</div>
            <div class="kpi-value" style="color:${ccAch >= 100 ? 'var(--success)' : 'var(--warning)'}">${ccAch}%</div>
            <div class="kpi-trend">Based on Delivery Agg.</div>
        </div>
        <div class="card">
            <i class="fas fa-store kpi-icon-bg"></i>
            <div class="kpi-label">Active Branches</div>
            <div class="kpi-value">${new Set(data.map(i=>i.branch)).size}</div>
            <div class="kpi-trend">Reporting Data</div>
        </div>
    `;
    document.getElementById('kpiContainer').innerHTML = html;
}

function getDaysInPeriod() {
    const p = document.getElementById('f_period').value;
    if(p === 'today') return 1;
    if(p === 'week') return 7;
    if(p === 'month') return 30;
    if(p === 'custom') {
        const s = new Date(document.getElementById('d_start').value);
        const e = new Date(document.getElementById('d_end').value);
        return Math.ceil((e - s) / (1000 * 60 * 60 * 24)) + 1;
    }
    return 1;
}

function renderLeaderboard(data) {
    const stats = {};
    data.forEach(i => {
        if(!stats[i.branch]) stats[i.branch] = { sales: 0, target: 0 };
        stats[i.branch].sales += i.total;
        stats[i.branch].target += i.target;
    });

    const ranked = Object.keys(stats).map(b => {
        const s = stats[b];
        const pct = s.target ? Math.round((s.sales/s.target)*100) : 0;
        let color = pct >= 100 ? 'var(--success)' : (pct >= 80 ? 'var(--warning)' : 'var(--danger)');
        return { name: b, sales: s.sales, target: s.target, pct, color };
    }).sort((a,b) => b.pct - a.pct);

    const tbody = document.getElementById('rankBody');
    if(ranked.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No data available</td></tr>';
        updatePerfChart([]);
        return;
    }

    tbody.innerHTML = ranked.map((r, i) => {
        const rankClass = i === 0 ? 'rank-1' : (i === 1 ? 'rank-2' : (i === 2 ? 'rank-3' : 'rank-other'));
        const shortName = r.name.replace('Crispy Chicken ', '');
        return `
            <tr>
                <td><div class="rank-circle ${rankClass}">${i+1}</div></td>
                <td><strong>${shortName}</strong></td>
                <td style="text-align:right; color:var(--text-muted)">${r.target.toLocaleString()}</td>
                <td style="text-align:right; font-weight:bold;">${r.sales.toLocaleString()}</td>
                <td>
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; font-weight:600;">
                        <span style="color:${r.color}">${r.pct}%</span>
                    </div>
                    <div class="progress-wrapper">
                        <div class="progress-fill" style="width:${Math.min(r.pct, 100)}%; background:${r.color}"></div>
                    </div>
                </td>
            </tr>
        `;
    }).join('');

    updatePerfChart(ranked);
}

function renderTable(data) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = data.map(item => {
        const ach = item.target ? Math.round((item.total/item.target)*100) : 0;
        const badgeClass = ach >= 100 ? 'badge-success' : (ach >= 80 ? 'badge-warning' : 'badge-danger');
        return `
        <tr>
            <td>${item.date}</td>
            <td><span style="font-weight:500">${item.branch.replace('Crispy Chicken ', '')}</span></td>
            <td style="font-weight:700">AED ${item.total.toLocaleString()}</td>
            <td>${item.transactions}</td>
            <td><span class="badge ${badgeClass}">${ach}%</span></td>
            <td>
                <div class="action-btns">
                    <button class="btn btn-icon btn-outline" onclick="editEntry(${item.id})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-icon btn-danger" onclick="deleteEntry(${item.id})"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        </tr>`;
    }).join('');
}

// --- CHARTS ---
function initCharts() {
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#6b7280';
    
    // 1. Trend Line
    const ctxTrend = document.getElementById('trendChart').getContext('2d');
    charts.trend = new Chart(ctxTrend, {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { grid: { borderDash: [2, 4] }, beginAtZero: true }, x: { grid: { display: false } } },
            elements: { line: { tension: 0.4 } }
        }
    });

    // 2. Sales Mix (Doughnut)
    const ctxMix = document.getElementById('mixChart').getContext('2d');
    charts.mix = new Chart(ctxMix, {
        type: 'doughnut',
        data: { labels: [], datasets: [] },
        options: {
            responsive: true, maintainAspectRatio: false,
            cutout: '70%',
            plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } }
        }
    });

    // 3. Performance Bar
    const ctxPerf = document.getElementById('perfChart').getContext('2d');
    charts.perf = new Chart(ctxPerf, {
        type: 'bar',
        data: { labels: [], datasets: [] },
        options: {
            indexAxis: 'y',
            responsive: true, maintainAspectRatio: false,
            scales: { x: { display: false }, y: { grid: { display: false } } },
            plugins: { legend: { display: false } }
        }
    });
}

function updateCharts(data) {
    // Trend
    const days = parseInt(document.getElementById('trendDays').value);
    const dateMap = {};
    for(let i=days-1; i>=0; i--) {
        const d = new Date(); d.setDate(d.getDate()-i);
        const k = d.toISOString().split('T')[0];
        dateMap[k] = 0;
    }
    data.forEach(d => { if(dateMap[d.date] !== undefined) dateMap[d.date] += d.total; });
    
    const labels = Object.keys(dateMap);
    charts.trend.data.labels = labels;
    charts.trend.data.datasets = [{
        label: 'Sales',
        data: labels.map(k => dateMap[k]),
        borderColor: '#dc2626',
        backgroundColor: (ctx) => {
            const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(220, 38, 38, 0.2)');
            gradient.addColorStop(1, 'rgba(220, 38, 38, 0)');
            return gradient;
        },
        fill: true,
        borderWidth: 2,
        pointBackgroundColor: '#ffffff',
        pointBorderColor: '#dc2626',
        pointRadius: 4
    }];
    charts.trend.update();

    // Mix
    const channels = { delivery: 0, online: 0, aggregator: 0, dining: 0 };
    data.forEach(d => {
        channels.delivery += d.delivery;
        channels.online += d.online;
        channels.aggregator += d.aggregator;
        channels.dining += d.dining;
    });
    charts.mix.data.labels = ['Delivery', 'Online', 'Aggregator', 'Dining'];
    charts.mix.data.datasets = [{
        data: Object.values(channels),
        backgroundColor: ['#dc2626', '#f87171', '#3b82f6', '#10b981'],
        borderWidth: 0
    }];
    charts.mix.update();
}

function updatePerfChart(ranked) {
    charts.perf.data.labels = ranked.map(r => r.name.replace('Crispy Chicken ', ''));
    charts.perf.data.datasets = [{
        label: 'Achievement %',
        data: ranked.map(r => r.pct),
        backgroundColor: ranked.map(r => r.color),
        borderRadius: 4,
        barThickness: 20
    }];
    charts.perf.update();
}

// --- FORMS & DATA HANDLING ---

function getFormValues(prefix) {
    const d = parseFloat(document.getElementById(`${prefix}_delivery`).value) || 0;
    const o = parseFloat(document.getElementById(`${prefix}_online`).value) || 0;
    const a = parseFloat(document.getElementById(`${prefix}_aggregator`).value) || 0;
    const di = parseFloat(document.getElementById(`${prefix}_dining`).value) || 0;
    
    return {
        id: Date.now(),
        branch: document.getElementById(`${prefix}_branch`).value,
        date: document.getElementById(`${prefix}_date`).value,
        delivery: d, online: o, aggregator: a, dining: di,
        total: d+o+a+di,
        transactions: parseInt(document.getElementById(`${prefix}_trans`).value) || 0,
        target: parseFloat(document.getElementById(`${prefix}_target`).value) || 0
    };
}

function handleQuickSubmit(e) {
    e.preventDefault();
    salesData.push(getFormValues('q'));
    save();
    e.target.reset();
    document.getElementById('q_date').value = new Date().toISOString().split('T')[0];
    showToast('Entry saved successfully!');
}

function handleModalSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('m_id').value;
    const entry = getFormValues('m');

    if(id) {
        entry.id = parseInt(id);
        const idx = salesData.findIndex(i => i.id === entry.id);
        if(idx !== -1) salesData[idx] = entry;
    } else {
        salesData.push(entry);
    }
    save();
    closeModal();
    showToast('Record updated!');
}

function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(salesData));
    refreshDashboard();
}

function editEntry(id) {
    const item = salesData.find(i => i.id === id);
    if(!item) return;
    document.getElementById('m_id').value = item.id;
    document.getElementById('m_branch').value = item.branch;
    document.getElementById('m_date').value = item.date;
    document.getElementById('m_delivery').value = item.delivery;
    document.getElementById('m_online').value = item.online;
    document.getElementById('m_aggregator').value = item.aggregator;
    document.getElementById('m_dining').value = item.dining;
    document.getElementById('m_trans').value = item.transactions;
    document.getElementById('m_target').value = item.target;
    
    document.getElementById('modalTitle').textContent = 'Edit Entry';
    document.getElementById('entryModal').classList.add('show');
}

function deleteEntry(id) {
    if(confirm('Are you sure you want to delete this entry?')) {
        salesData = salesData.filter(i => i.id !== id);
        save();
        showToast('Entry deleted.', 'error');
    }
}

function clearAllData() {
    if(confirm('WARNING: This will delete all sales data. This cannot be undone.')) {
        salesData = [];
        save();
        showToast('All data cleared.', 'error');
    }
}

// --- UTILS ---
function openModal() {
    document.getElementById('modalForm').reset();
    document.getElementById('m_id').value = '';
    document.getElementById('m_date').value = new Date().toISOString().split('T')[0];
    document.getElementById('modalTitle').textContent = 'New Entry';
    document.getElementById('entryModal').classList.add('show');
}
function closeModal() { document.getElementById('entryModal').classList.remove('show'); }

function showToast(msg, type='success') {
    const t = document.getElementById('toast');
    document.getElementById('toastMsg').textContent = msg;
    t.style.background = type === 'error' ? 'var(--danger)' : 'var(--text-main)';
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

function exportData() {
    if(!salesData.length) return showToast('No data to export', 'error');
    const csv = 'Date,Branch,Delivery,Online,Aggregator,Dining,Total,Transactions,Target\n' + 
    salesData.map(i => `${i.date},"${i.branch}",${i.delivery},${i.online},${i.aggregator},${i.dining},${i.total},${i.transactions},${i.target}`).join('\n');
    
    const blob = new Blob([csv], {type: 'text/csv'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `crispy_sales_export_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

function importCSV(input) {
    const file = input.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n');
        let count = 0;
        
        lines.slice(1).forEach(line => {
            const cols = line.split(',');
            if(cols.length >= 5) {
                const total = parseFloat(cols[6]) || 0;
                // Basic validation check
                if(cols[0] && cols[1]) {
                    salesData.push({
                        id: Date.now() + Math.random(),
                        date: cols[0].trim(),
                        branch: cols[1].replace(/"/g, '').trim(),
                        delivery: parseFloat(cols[2])||0,
                        online: parseFloat(cols[3])||0,
                        aggregator: parseFloat(cols[4])||0,
                        dining: parseFloat(cols[5])||0,
                        total: total || (parseFloat(cols[2])+parseFloat(cols[3])+parseFloat(cols[4])+parseFloat(cols[5])),
                        transactions: parseInt(cols[7])||0,
                        target: parseFloat(cols[8])||0
                    });
                    count++;
                }
            }
        });
        save();
        showToast(`Imported ${count} records`);
        input.value = ''; // Reset file input
    };
    reader.readAsText(file);
}
</script>
</body>
</html>
