<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crispy Chicken Sales Dashboard</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS for Excel processing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Luxon for date handling -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #e63946;
      --secondary: #1d3557;
      --light: #f1faee;
      --dark: #457b9d;
      --success: #2a9d8f;
      --warning: #e9c46a;
      --danger: #f4a261;
      --card-bg: #ffffff;
      --border: #dee2e6;
      --text: #333;
      --bg: #f8f9fa;
    }
    
    /* Dark mode styles */
    body.dark-mode {
      --card-bg: #2d3748;
      --border: #4a5568;
      --text: #e2e8f0;
      --bg: #1a202c;
    }
    
    body.dark-mode .card,
    body.dark-mode .tab-content,
    body.dark-mode .data-management,
    body.dark-mode .filters {
      background: var(--card-bg);
      color: var(--text);
    }
    
    body.dark-mode .analysis-table th,
    body.dark-mode .analysis-table td {
      border-color: var(--border);
    }
    
    body.dark-mode .tabs {
      border-bottom-color: var(--border);
    }
    
    body.dark-mode .tab {
      color: #cbd5e0;
    }
    
    body.dark-mode .tab.active {
      color: var(--primary);
    }
    
    body.dark-mode .upload-area {
      background: #374151;
      border-color: #4a5568;
    }
    
    body.dark-mode .upload-area:hover,
    body.dark-mode .upload-area.dragover {
      background: #4a5568;
    }
    
    body.dark-mode .filter-group select,
    body.dark-mode .filter-group input {
      background: #374151;
      color: var(--text);
      border-color: var(--border);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
      color: var(--secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    h1 {
      font-size: 2.2rem;
      margin-bottom: 8px;
    }
    .subtitle {
      color: #666;
      font-size: 1rem;
    }
    
    /* Controls */
    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover {
      background: #d62839;
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: var(--light);
      color: var(--secondary);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover {
      background: #e6f0e9;
    }
    .btn-icon {
      padding: 8px;
      background: transparent;
      color: var(--secondary);
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-icon:hover {
      background: rgba(0,0,0,0.1);
    }
    .dark-mode-toggle {
      position: relative;
      width: 50px;
      height: 24px;
      background: #ccc;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .dark-mode-toggle.active {
      background: var(--primary);
    }
    .dark-mode-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    .dark-mode-toggle.active::after {
      transform: translateX(26px);
    }

    /* Data Management Section */
    .data-management {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    .upload-area {
      flex: 1;
      min-width: 280px;
      border: 2.5px dashed var(--border);
      border-radius: 10px;
      padding: 25px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .upload-area:hover, .upload-area.dragover {
      border-color: var(--primary);
      background-color: #fdf2f3;
    }
    .upload-area i {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 10px;
    }
    .upload-text {
      font-weight: 600;
      color: var(--secondary);
    }
    .upload-subtext {
      font-size: 0.85rem;
      color: #888;
      margin-top: 5px;
    }

    /* Filters */
    .filters {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    .filter-group label {
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--secondary);
      font-size: 0.9rem;
    }
    .filter-group select,
    .filter-group input {
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      background: white;
    }
    body.dark-mode .filter-group select,
    body.dark-mode .filter-group input {
      background: #374151;
      color: var(--text);
    }
    .filter-group input[type="date"] {
      font-family: inherit;
    }

    /* Summary Cards */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
      margin-bottom: 30px;
    }
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-3px);
    }
    .card-title {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .card-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--secondary);
    }
    .card-subtitle {
      font-size: 0.85rem;
      color: #888;
      margin-top: 4px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    .tab:hover:not(.active) {
      color: var(--secondary);
    }

    /* Tab Content */
    .tab-content {
      display: none;
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .tab-content.active {
      display: block;
    }
    .chart-container {
      position: relative;
      height: 380px;
      margin-bottom: 20px;
    }
    .analysis-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 0.9rem;
    }
    .analysis-table th {
      background: #f4f6f8;
      text-align: left;
      padding: 12px;
      font-weight: 600;
      color: var(--secondary);
      border-bottom: 2px solid var(--border);
    }
    .analysis-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    .analysis-table tr:hover {
      background: #f8f9fa;
    }

    /* Grid for Sections */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
      margin-bottom: 30px;
    }
    @media (max-width: 992px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .data-management {
        flex-direction: column;
        align-items: stretch;
      }
      .filters {
        grid-template-columns: 1fr;
      }
      .summary-cards {
        grid-template-columns: 1fr;
      }
      .tabs {
        justify-content: center;
      }
      header {
        flex-direction: column;
        text-align: center;
      }
      .controls {
        justify-content: center;
        margin-top: 15px;
      }
    }

    /* Loading & Error */
    .loading, .error {
      text-align: center;
      padding: 20px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .loading {
      background: #e3f2fd;
      color: #1565c0;
    }
    .error {
      background: #ffebee;
      color: #c62828;
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 30px 20px;
      color: #888;
      font-size: 0.9rem;
      margin-top: 50px;
      border-top: 1px solid var(--border);
    }

    /* Export dropdown */
    .export-dropdown {
      position: relative;
      display: inline-block;
    }
    .export-menu {
      display: none;
      position: absolute;
      right: 0;
      background: var(--card-bg);
      min-width: 160px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      z-index: 1;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .export-menu.show {
      display: block;
    }
    .export-menu a {
      color: var(--text);
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      transition: background 0.3s;
    }
    .export-menu a:hover {
      background: #f1f1f1;
    }
    .export-menu i {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Crispy Chicken Sales Dashboard</h1>
        <p class="subtitle">Real-time insights into sales, delivery, and payment performance</p>
      </div>
      <div class="controls">
        <button class="btn btn-secondary" id="refreshBtn">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <div class="export-dropdown">
          <button class="btn btn-secondary" id="exportBtn">
            <i class="fas fa-download"></i> Export
          </button>
          <div class="export-menu" id="exportMenu">
            <a href="#" id="exportPDF"><i class="fas fa-file-pdf"></i> Export PDF</a>
            <a href="#" id="exportExcel"><i class="fas fa-file-excel"></i> Export Excel</a>
          </div>
        </div>
        <div class="dark-mode-toggle" id="darkModeToggle"></div>
      </div>
    </header>

    <!-- Data Management -->
    <div class="data-management">
      <div class="upload-area" id="dropArea">
        <div>
          <div class="upload-text">Drop Excel file here or click to upload</div>
          <p class="upload-subtext">Supports .xlsx files up to 10MB</p>
          <input type="file" id="fileInput" accept=".xlsx" hidden />
        </div>
      </div>
      <div>
        <a href="#" class="btn btn-secondary" id="downloadTemplate">
          <i class="fas fa-file-download"></i> Download Template
        </a>
        <button class="btn btn-secondary" id="clearFilters" style="margin-left: 10px;">
          <i class="fas fa-eraser"></i> Clear Filters
        </button>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label for="filterMonth">Month</label>
        <select id="filterMonth">
          <option value="">All Months</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filterYear">Year</label>
        <select id="filterYear">
          <option value="">All Years</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filterBranch">Branch</label>
        <select id="filterBranch">
          <option value="">All Branches</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filterDateFrom">Date From</label>
        <input type="date" id="filterDateFrom" />
      </div>
      <div class="filter-group">
        <label for="filterDateTo">Date To</label>
        <input type="date" id="filterDateTo" />
      </div>
      <div class="filter-group" style="align-self: end;">
        <button class="btn btn-primary" id="applyFilters">
          <i class="fas fa-filter"></i> Apply Filters
        </button>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="card">
        <div class="card-title">Total Receipts</div>
        <div class="card-value" id="totalReceipts">AED 0</div>
        <div class="card-subtitle">All filtered data</div>
      </div>
      <div class="card">
        <div class="card-title">Total Delivery</div>
        <div class="card-value" id="totalDelivery">AED 0</div>
        <div class="card-subtitle">Internal delivery</div>
      </div>
      <div class="card">
        <div class="card-title">Total Online</div>
        <div class="card-value" id="totalOnline">AED 0</div>
        <div class="card-subtitle">ONLINE CASH + CARD</div>
      </div>
      <div class="card">
        <div class="card-title">Total Platforms</div>
        <div class="card-value" id="totalPlatforms">AED 0</div>
        <div class="card-subtitle">Third-party platforms</div>
      </div>
      <div class="card">
        <div class="card-title">Card Payments</div>
        <div class="card-value" id="cardPercentage">0%</div>
        <div class="card-subtitle">of total receipts</div>
      </div>
      <div class="card">
        <div class="card-title">Cash Payments</div>
        <div class="card-value" id="cashPercentage">0%</div>
        <div class="card-subtitle">of total receipts</div>
      </div>
      <div class="card">
        <div class="card-title">Total Transactions</div>
        <div class="card-value" id="totalTransactions">0</div>
        <div class="card-subtitle">Count of all receipts</div>
      </div>
      <div class="card">
        <div class="card-title">Avg Transaction Value</div>
        <div class="card-value" id="avgTransaction">AED 0</div>
        <div class="card-subtitle">Total / Transactions</div>
      </div>
    </div>

    <!-- Payment Method Analysis -->
    <div class="section">
      <h2 style="margin-bottom: 15px; color: var(--secondary);">Payment Method Analysis</h2>
      <div class="tabs">
        <div class="tab active" data-tab="visa-master">Visa vs Mastercard</div>
        <div class="tab" data-tab="cash-card">Cash vs Card</div>
        <div class="tab" data-tab="platform-perf">Platform Performance</div>
      </div>

      <!-- Visa vs Mastercard -->
      <div class="tab-content active" id="visa-master">
        <div class="dashboard-grid">
          <div>
            <div class="chart-container">
              <canvas id="visaMasterChart"></canvas>
            </div>
          </div>
          <div>
            <table class="analysis-table" id="visaMasterTable">
              <thead>
                <tr>
                  <th>Method</th>
                  <th>Total (AED)</th>
                  <th>Transactions</th>
                  <th>Avg (AED)</th>
                  <th>Share</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Cash vs Card -->
      <div class="tab-content" id="cash-card">
        <div class="dashboard-grid">
          <div>
            <div class="chart-container">
              <canvas id="cashCardChart"></canvas>
            </div>
          </div>
          <div>
            <table class="analysis-table" id="cashCardTable">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Total (AED)</th>
                  <th>Transactions</th>
                  <th>Percentage</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Platform Performance -->
      <div class="tab-content" id="platform-perf">
        <div class="dashboard-grid">
          <div>
            <div class="chart-container">
              <canvas id="platformPieChart"></canvas>
            </div>
          </div>
          <div>
            <table class="analysis-table" id="platformTable">
              <thead>
                <tr>
                  <th>Platform</th>
                  <th>Total (AED)</th>
                  <th>Transactions</th>
                  <th>Avg (AED)</th>
                  <th>Share</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Delivery Performance -->
    <div class="section" style="margin-top: 40px;">
      <h2 style="margin-bottom: 15px; color: var(--secondary);">Delivery Performance</h2>
      <div class="tabs">
        <div class="tab active" data-tab="branch-comp">Branch Comparison</div>
        <div class="tab" data-tab="delivery-types">Delivery Types</div>
        <div class="tab" data-tab="monthly-trends">Monthly Trends</div>
        <div class="tab" data-tab="internal-trends">Internal Delivery Trends</div>
      </div>

      <!-- Branch Comparison -->
      <div class="tab-content active" id="branch-comp">
        <div class="chart-container" style="height: 450px;">
          <canvas id="branchComparisonChart"></canvas>
        </div>
      </div>

      <!-- Delivery Types -->
      <div class="tab-content" id="delivery-types">
        <div class="dashboard-grid">
          <div>
            <div class="chart-container">
              <canvas id="deliveryTypesChart"></canvas>
            </div>
          </div>
          <div>
            <table class="analysis-table" id="deliveryTypesTable">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Total (AED)</th>
                  <th>Percentage</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Monthly Trends -->
      <div class="tab-content" id="monthly-trends">
        <div class="chart-container" style="height: 450px;">
          <canvas id="monthlyTrendsChart"></canvas>
        </div>
      </div>

      <!-- Internal Delivery Trends -->
      <div class="tab-content" id="internal-trends">
        <div class="chart-container" style="height: 450px;">
          <canvas id="internalTrendsChart"></canvas>
        </div>
      </div>
    </div>

    <div id="loadingMessage" class="loading" style="display: none;">
      <i class="fas fa-spinner fa-spin"></i> Processing data...
    </div>
    <div id="errorMessage" class="error" style="display: none;"></div>
  </div>

  <footer>
    <p>Â© 2025 Crispy Chicken Analytics | Data updated: <span id="lastUpdated">Never</span></p>
  </footer>

  <script>
    // Global variables
    let rawData = [];
    let filteredData = [];
    let charts = {};
    
    // Check for saved dark mode preference
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
      document.getElementById('darkModeToggle').classList.add('active');
    }

    // Sample data from the provided document
    const sampleData = `HEAD*,Branch*,Month*,Year*,Receipts*,TALABAT,TABNA,Keeta CARD,Cash,NOON CARD,Master card,Visa Card,Careem CARD,Delivery CARD,SMILES CARD,Delivery Cash,DELIVERO CARD,ONLINE CASH,ONLINE CARD,Count_Receipts,Count_TALABAT,Count_TABNA,Count_Keeta,Count_Cash,Count_NOON,Count_Master,Count_Visa,Count_Careem,Count_DeliveryCard,Count_SMILES,Count_DeliveryCash,Count_DELIVERO,Count_ONLINE_Cash,Count_ONLINE_Card
HEAD,Crispy Chicken-Hamdan St,1,2025,785537.88,55272.96,0,0,207908.13,79328.39,125061.73,78456.25,38265.58,23471.38,50561,95829.04,5482.62,15755.12,9790.68,26775,1144,0,0,9935,2238,4594,2770,1167,449,1498,2308,97,377,192
HEAD,Crispy Chicken Khaldia,1,2025,584685.4,62454.93,92.59,0,139821,67034.34,88632.53,73895.9,25667.99,13905.94,44374.88,46454.41,8601.88,9089.81,4659.2,19523,1217,2,0,6647,1897,3458,2477,812,249,1343,992,137,202,90
HEAD,Crispy Chicken Shabiya 11,1,2025,630955.6,35802.49,75,0,167078.54,79487.04,102733.74,69778.54,34104.18,18043.94,77531.22,34733.77,4263.98,4779.37,2618.79,21470,705,2,0,7395,2215,3814,2436,1074,366,2399,835,54,119,58
HEAD,Crispy Chicken Muroor,1,2025,527597.59,48211.79,35,0,120193.1,50495.26,83440.34,85619.29,32059.59,23144.36,40854.29,36604.32,3547.86,1861.7,1490.69,17770,969,1,0,5888,1452,2990,2820,963,467,1294,788,65,41,31
HEAD,Crispy Chicken Al Barsha,1,2025,611173.74,38175.48,0,0,178819.55,66462.64,73224.5,84120.81,49244.9,27673.05,50254.01,28078.99,6794.63,5677.37,2647.81,24058,839,0,0,8938,1902,3357,3712,1652,854,1657,872,119,113,43
HEAD,Crispy Chicken Al Satwa,1,2025,385718.26,28527.83,0,0,124512.61,71302.62,34050.62,34706.38,31417.87,6986.61,25312.49,19861.9,1432.48,5835.16,1736.69,14065,632,0,0,5698,2076,1352,1314,1103,171,837,647,24,167,43
HEAD,Crispy Chicken Al Rgga,1,2025,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
HEAD,Crispy Chicken-ELctria,1,2025,740083.76,52228.79,0,0,300244.92,91589.3,150467.4,81937.11,27260.97,0,36355.27,0,0,0,0,30341,1041,0,0,15547,2623,6077,3164,867,0,1022,0,139,0,0
HEAD,Crispy Chicken-Hamdan St,2,2025,742068.15,55021,0,0,183743.1,71094.5,107837.1,70459.9,39408.15,21608.3,67595.7,89937.3,5805.2,17714.4,10974.5,25749,1176,0,0,8862,2008,4155,2433,1091,424,2746,2036,0,417,227
HEAD,Crispy Chicken Khaldia,2,2025,566345.35,46961,0,0,132388.5,74018.8,84054.2,68511.6,38073.4,13376.8,47101.9,38340.9,0,9389.9,5271.9,18616,962,0,0,6357,2007,3228,2175,654,234,1685,820,189,206,99`.split('\n').map(row => row.split(','));

    // Initialize with sample data
    document.addEventListener('DOMContentLoaded', () => {
      processExcelData(sampleData);
      setupEventListeners();
      populateFilters();
      updateDashboard();
      document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
    });

    // Setup event listeners
    function setupEventListeners() {
      const dropArea = document.getElementById('dropArea');
      const fileInput = document.getElementById('fileInput');

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
      });

      ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false);
      });

      dropArea.addEventListener('drop', handleDrop, false);
      dropArea.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', () => handleFile(fileInput.files[0]));

      document.getElementById('applyFilters').addEventListener('click', applyFilters);
      document.getElementById('downloadTemplate').addEventListener('click', downloadTemplate);
      document.getElementById('clearFilters').addEventListener('click', clearFilters);
      document.getElementById('refreshBtn').addEventListener('click', refreshData);
      document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
      
      // Export dropdown
      document.getElementById('exportBtn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('exportMenu').classList.toggle('show');
      });
      
      document.addEventListener('click', () => {
        document.getElementById('exportMenu').classList.remove('show');
      });
      
      document.getElementById('exportPDF').addEventListener('click', exportToPDF);
      document.getElementById('exportExcel').addEventListener('click', exportToExcel);

      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const parent = tab.closest('.tabs').parentElement;
          parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab).classList.add('active');
        });
      });
    }

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files.length > 0) handleFile(files[0]);
    }

    function handleFile(file) {
      if (!file) return;
      if (!file.name.endsWith('.xlsx')) {
        showError('Please upload an Excel (.xlsx) file.');
        return;
      }
      if (file.size > 10 * 1024 * 1024) {
        showError('File size must be under 10MB.');
        return;
      }

      showLoading('Reading Excel file...');
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const csv = XLSX.utils.sheet_to_csv(sheet);
          const rows = csv.split('\n').map(row => row.split(','));
          processExcelData(rows);
          showLoading('Processing data...');
          setTimeout(() => {
            hideLoading();
            populateFilters();
            applyFilters();
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
          }, 300);
        } catch (err) {
          showError('Failed to process Excel file: ' + err.message);
          hideLoading();
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function processExcelData(rows) {
      if (rows.length < 2) return;
      const headers = rows[0].map(h => h.replace(/\*$/g, '').trim());
      rawData = rows.slice(1).map(row => {
        const obj = {};
        headers.forEach((h, i) => {
          let val = row[i] ? row[i].trim() : '';
          if (!isNaN(val) && val !== '') {
            obj[h] = parseFloat(val);
          } else {
            obj[h] = val;
          }
        });
        // Create date from Month and Year
        if (obj.Month && obj.Year) {
          obj.Date = new Date(obj.Year, obj.Month - 1, 1);
        }
        return obj;
      }).filter(row => row.Branch && row.Branch.includes('Crispy Chicken') && row.Receipts > 0);
      filteredData = [...rawData];
    }

    function populateFilters() {
      const months = [...new Set(rawData.map(r => r.Month))].sort((a,b) => a-b);
      const years = [...new Set(rawData.map(r => r.Year))].sort((a,b) => a-b);
      const branches = [...new Set(rawData.map(r => r.Branch))].sort();

      const monthSelect = document.getElementById('filterMonth');
      monthSelect.innerHTML = '<option value="">All Months</option>';
      months.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = new Date(2025, m-1, 1).toLocaleString('default', { month: 'long' });
        monthSelect.appendChild(opt);
      });

      const yearSelect = document.getElementById('filterYear');
      yearSelect.innerHTML = '<option value="">All Years</option>';
      years.forEach(y => {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        yearSelect.appendChild(opt);
      });

      const branchSelect = document.getElementById('filterBranch');
      branchSelect.innerHTML = '<option value="">All Branches</option>';
      branches.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b;
        opt.textContent = b.replace('Crispy Chicken', '').trim() || 'Main';
        branchSelect.appendChild(opt);
      });
    }

    function applyFilters() {
      const month = document.getElementById('filterMonth').value;
      const year = document.getElementById('filterYear').value;
      const branch = document.getElementById('filterBranch').value;
      const from = document.getElementById('filterDateFrom').value;
      const to = document.getElementById('filterDateTo').value;

      filteredData = rawData.filter(row => {
        if (month && row.Month != month) return false;
        if (year && row.Year != year) return false;
        if (branch && row.Branch !== branch) return false;
        if (from) {
          const rowDate = new Date(row.Year, row.Month - 1, 1);
          const fromDate = new Date(from);
          if (rowDate < fromDate) return false;
        }
        if (to) {
          const rowDate = new Date(row.Year, row.Month - 1, 1);
          const toDate = new Date(to);
          toDate.setMonth(toDate.getMonth() + 1);
          if (rowDate >= toDate) return false;
        }
        return true;
      });

      updateDashboard();
    }

    function clearFilters() {
      document.getElementById('filterMonth').value = '';
      document.getElementById('filterYear').value = '';
      document.getElementById('filterBranch').value = '';
      document.getElementById('filterDateFrom').value = '';
      document.getElementById('filterDateTo').value = '';
      filteredData = [...rawData];
      updateDashboard();
    }

    function refreshData() {
      showLoading('Refreshing data...');
      setTimeout(() => {
        updateDashboard();
        hideLoading();
        document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
      }, 1000);
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      document.getElementById('darkModeToggle').classList.toggle('active');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
      
      // Update chart colors for dark mode
      Object.values(charts).forEach(chart => {
        if (chart) {
          updateChartForDarkMode(chart);
        }
      });
    }

    function updateChartForDarkMode(chart) {
      if (chart.options.scales) {
        Object.values(chart.options.scales).forEach(scale => {
          if (scale.ticks) {
            scale.ticks.color = document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333';
          }
          if (scale.grid) {
            scale.grid.color = document.body.classList.contains('dark-mode') ? '#4a5568' : '#dee2e6';
          }
        });
      }
      
      if (chart.options.plugins && chart.options.plugins.legend) {
        chart.options.plugins.legend.labels.color = document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333';
      }
      
      chart.update();
    }

    function exportToPDF() {
      showLoading('Generating PDF report...');
      // In a real implementation, you would use a PDF library like jsPDF
      setTimeout(() => {
        hideLoading();
        alert('PDF export functionality would be implemented here with a library like jsPDF');
      }, 1500);
    }

    function exportToExcel() {
      showLoading('Generating Excel report...');
      
      // Create a new workbook
      const wb = XLSX.utils.book_new();
      
      // Prepare summary data
      const summary = [
        ['Metric', 'Value'],
        ['Total Receipts', document.getElementById('totalReceipts').textContent],
        ['Total Delivery', document.getElementById('totalDelivery').textContent],
        ['Total Online', document.getElementById('totalOnline').textContent],
        ['Total Platforms', document.getElementById('totalPlatforms').textContent],
        ['Card Payments', document.getElementById('cardPercentage').textContent],
        ['Cash Payments', document.getElementById('cashPercentage').textContent],
        ['Total Transactions', document.getElementById('totalTransactions').textContent],
        ['Avg Transaction Value', document.getElementById('avgTransaction').textContent]
      ];
      
      // Create worksheet for summary
      const wsSummary = XLSX.utils.aoa_to_sheet(summary);
      
      // Create worksheet for filtered data
      const headers = Object.keys(filteredData[0] || {});
      const wsData = XLSX.utils.json_to_sheet(filteredData);
      
      // Add worksheets to workbook
      XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
      XLSX.utils.book_append_sheet(wb, wsData, 'Data');
      
      // Generate and download file
      XLSX.writeFile(wb, 'Crispy_Chicken_Sales_Report.xlsx');
      hideLoading();
    }

    function updateDashboard() {
      updateSummaryCards();
      updatePaymentAnalysis();
      updateDeliveryPerformance();
    }

    function updateSummaryCards() {
      const totalReceipts = filteredData.reduce((sum, r) => sum + (r.Receipts || 0), 0);
      
      // Corrected platform sales calculation including all platforms
      const allPlatformFields = [
        'TALABAT', 'TABNA', 'Keeta CARD', 'NOON CARD', 
        'Master card', 'Visa Card', 'Careem CARD', 
        'SMILES CARD', 'DELIVERO CARD'
      ];
      
      const platforms = filteredData.reduce((sum, r) => {
        return sum + allPlatformFields.reduce((platformSum, field) => {
          return platformSum + (r[field] || 0);
        }, 0);
      }, 0);
      
      const internalDelivery = filteredData.reduce((sum, r) => sum + (r['Delivery CARD'] || 0) + (r['Delivery Cash'] || 0), 0);
      const online = filteredData.reduce((sum, r) => sum + (r['ONLINE CASH'] || 0) + (r['ONLINE CARD'] || 0), 0);
      
      const cardPayments = filteredData.reduce((sum, r) => sum + 
        (r['Visa Card'] || 0) + (r['Master card'] || 0) + (r['NOON CARD'] || 0) + 
        (r['Careem CARD'] || 0) + (r['SMILES CARD'] || 0) + (r['DELIVERO CARD'] || 0) + 
        (r['ONLINE CARD'] || 0) + (r['Delivery CARD'] || 0) + (r['Keeta CARD'] || 0), 0);
      const cashPayments = filteredData.reduce((sum, r) => sum + (r.Cash || 0) + (r['Delivery Cash'] || 0) + (r['ONLINE CASH'] || 0), 0);

      const totalTransactions = filteredData.reduce((sum, r) => sum + (r.Count_Receipts || 0), 0);
      const avgTransactionValue = totalTransactions > 0 ? totalReceipts / totalTransactions : 0;

      const cardPct = totalReceipts > 0 ? (cardPayments / totalReceipts * 100).toFixed(1) : 0;
      const cashPct = totalReceipts > 0 ? (cashPayments / totalReceipts * 100).toFixed(1) : 0;

      document.getElementById('totalReceipts').textContent = formatCurrency(totalReceipts);
      document.getElementById('totalDelivery').textContent = formatCurrency(internalDelivery);
      document.getElementById('totalOnline').textContent = formatCurrency(online);
      document.getElementById('totalPlatforms').textContent = formatCurrency(platforms);
      document.getElementById('cardPercentage').textContent = cardPct + '%';
      document.getElementById('cashPercentage').textContent = cashPct + '%';
      document.getElementById('totalTransactions').textContent = totalTransactions.toLocaleString();
      document.getElementById('avgTransaction').textContent = formatCurrency(avgTransactionValue);
    }

    function updatePaymentAnalysis() {
      updateVisaMaster();
      updateCashCard();
      updatePlatformPerformance();
    }

    function updateVisaMaster() {
      const visaTotal = filteredData.reduce((sum, r) => sum + (r['Visa Card'] || 0), 0);
      const masterTotal = filteredData.reduce((sum, r) => sum + (r['Master card'] || 0), 0);
      const visaCount = filteredData.reduce((sum, r) => sum + (r.Count_Visa || 0), 0);
      const masterCount = filteredData.reduce((sum, r) => sum + (r.Count_Master || 0), 0);
      const total = visaTotal + masterTotal;

      const visaAvg = visaCount > 0 ? visaTotal / visaCount : 0;
      const masterAvg = masterCount > 0 ? masterTotal / masterCount : 0;
      const visaShare = total > 0 ? (visaTotal / total * 100).toFixed(1) : 0;
      const masterShare = total > 0 ? (masterTotal / total * 100).toFixed(1) : 0;

      // Chart
      if (charts.visaMaster) charts.visaMaster.destroy();
      charts.visaMaster = new Chart(document.getElementById('visaMasterChart'), {
        type: 'bar',
        data: {
          labels: ['Visa', 'Mastercard'],
          datasets: [{
            label: 'Total Amount (AED)',
            data: [visaTotal, masterTotal],
            backgroundColor: ['#4CAF50', '#2196F3'],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => formatCurrency(ctx.parsed.y) } }
          },
          scales: {
            y: { 
              beginAtZero: true, 
              ticks: { 
                callback: value => 'AED ' + abbreviateNumber(value),
                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
              },
              grid: {
                color: document.body.classList.contains('dark-mode') ? '#4a5568' : '#dee2e6'
              }
            },
            x: {
              ticks: {
                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
              },
              grid: {
                color: document.body.classList.contains('dark-mode') ? '#4a5568' : '#dee2e6'
              }
            }
          }
        }
      });

      // Table
      const tbody = document.querySelector('#visaMasterTable tbody');
      tbody.innerHTML = `
        <tr><td>Visa</td><td>${formatCurrency(visaTotal)}</td><td>${visaCount}</td><td>${formatCurrency(visaAvg)}</td><td>${visaShare}%</td></tr>
        <tr><td>Mastercard</td><td>${formatCurrency(masterTotal)}</td><td>${masterCount}</td><td>${formatCurrency(masterAvg)}</td><td>${masterShare}%</td></tr>
      `;
    }

    function updateCashCard() {
      const cardTotal = filteredData.reduce((sum, r) => sum + 
        (r['Visa Card'] || 0) + (r['Master card'] || 0) + (r['NOON CARD'] || 0) + 
        (r['Careem CARD'] || 0) + (r['SMILES CARD'] || 0) + (r['DELIVERO CARD'] || 0) + 
        (r['ONLINE CARD'] || 0) + (r['Delivery CARD'] || 0) + (r['Keeta CARD'] || 0), 0);
      const cashTotal = filteredData.reduce((sum, r) => sum + (r.Cash || 0) + (r['Delivery Cash'] || 0) + (r['ONLINE CASH'] || 0), 0);
      const total = cardTotal + cashTotal;

      const cardCount = filteredData.reduce((sum, r) => sum + 
        (r.Count_Visa || 0) + (r.Count_Master || 0) + (r.Count_NOON || 0) + 
        (r.Count_Careem || 0) + (r.Count_SMILES || 0) + (r.Count_DELIVERO || 0) + 
        (r.Count_ONLINE_Card || 0) + (r.Count_DeliveryCard || 0) + (r.Count_Keeta || 0), 0);
      const cashCount = filteredData.reduce((sum, r) => sum + (r.Count_Cash || 0) + (r.Count_DeliveryCash || 0) + (r.Count_ONLINE_Cash || 0), 0);

      // Chart
      if (charts.cashCard) charts.cashCard.destroy();
      charts.cashCard = new Chart(document.getElementById('cashCardChart'), {
        type: 'doughnut',
        data: {
          labels: ['Card Payments', 'Cash Payments'],
          datasets: [{
            data: [cardTotal, cashTotal],
            backgroundColor: ['#FF9800', '#4CAF50'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.parsed)}` } }
          }
        }
      });

      // Table
      const tbody = document.querySelector('#cashCardTable tbody');
      tbody.innerHTML = `
        <tr><td>Card</td><td>${formatCurrency(cardTotal)}</td><td>${cardCount}</td><td>${total > 0 ? (cardTotal / total * 100).toFixed(1) : 0}%</td></tr>
        <tr><td>Cash</td><td>${formatCurrency(cashTotal)}</td><td>${cashCount}</td><td>${total > 0 ? (cashTotal / total * 100).toFixed(1) : 0}%</td></tr>
      `;
    }

    function updatePlatformPerformance() {
      // All platform fields including Keeta and others
      const allPlatformFields = [
        { name: 'TALABAT', field: 'TALABAT', count: 'Count_TALABAT' },
        { name: 'TABNA', field: 'TABNA', count: 'Count_TABNA' },
        { name: 'Keeta', field: 'Keeta CARD', count: 'Count_Keeta' },
        { name: 'NOON', field: 'NOON CARD', count: 'Count_NOON' },
        { name: 'Mastercard', field: 'Master card', count: 'Count_Master' },
        { name: 'Visa', field: 'Visa Card', count: 'Count_Visa' },
        { name: 'Careem', field: 'Careem CARD', count: 'Count_Careem' },
        { name: 'Smiles', field: 'SMILES CARD', count: 'Count_SMILES' },
        { name: 'Deliveroo', field: 'DELIVERO CARD', count: 'Count_DELIVERO' }
      ];

      const data = allPlatformFields.map(p => ({
        name: p.name,
        total: filteredData.reduce((sum, r) => sum + (r[p.field] || 0), 0),
        count: filteredData.reduce((sum, r) => sum + (r[p.count] || 0), 0)
      })).filter(d => d.total > 0);

      const total = data.reduce((sum, d) => sum + d.total, 0);
      data.forEach(d => {
        d.avg = d.count > 0 ? d.total / d.count : 0;
        d.share = total > 0 ? (d.total / total * 100).toFixed(1) : 0;
      });

      // Chart
      if (charts.platformPie) charts.platformPie.destroy();
      charts.platformPie = new Chart(document.getElementById('platformPieChart'), {
        type: 'pie',
        data: {
          labels: data.map(d => d.name),
          datasets: [{
            data: data.map(d => d.total),
            backgroundColor: ['#e63946', '#2a9d8f', '#f4a261', '#e9c46a', '#457b9d', '#1d3557', '#a8dadc', '#457b9d', '#1d3557'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right' },
            tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.parsed)}` } }
          }
        }
      });

      // Table
      const tbody = document.querySelector('#platformTable tbody');
      tbody.innerHTML = data.map(d => `
        <tr>
          <td>${d.name}</td>
          <td>${formatCurrency(d.total)}</td>
          <td>${d.count}</td>
          <td>${formatCurrency(d.avg)}</td>
          <td>${d.share}%</td>
        </tr>
      `).join('');
    }

    function updateDeliveryPerformance() {
      updateBranchComparison();
      updateDeliveryTypes();
      updateMonthlyTrends();
      updateInternalTrends();
    }

    function updateBranchComparison() {
      const branches = [...new Set(filteredData.map(r => r.Branch))];
      
      // All platform fields for third-party platforms
      const allPlatformFields = [
        'TALABAT', 'TABNA', 'Keeta CARD', 'NOON CARD', 
        'Master card', 'Visa Card', 'Careem CARD', 
        'SMILES CARD', 'DELIVERO CARD'
      ];
      
      const internalData = branches.map(b => {
        const branchData = filteredData.filter(r => r.Branch === b);
        return branchData.reduce((sum, r) => sum + (r['Delivery CARD'] || 0) + (r['Delivery Cash'] || 0), 0);
      });
      
      const platformData = branches.map(b => {
        const branchData = filteredData.filter(r => r.Branch === b);
        return branchData.reduce((sum, r) => {
          return sum + allPlatformFields.reduce((platformSum, field) => {
            return platformSum + (r[field] || 0);
          }, 0);
        }, 0);
      });

      if (charts.branchComparison) charts.branchComparison.destroy();
      charts.branchComparison = new Chart(document.getElementById('branchComparisonChart'), {
        type: 'bar',
        data: {
          labels: branches.map(b => b.replace('Crispy Chicken', '').trim() || 'Main'),
          datasets: [
            {
              label: 'Internal Delivery',
              data: internalData,
              backgroundColor: '#2a9d8f'
            },
            {
              label: 'Third-Party Platforms',
              data: platformData,
              backgroundColor: '#e63946'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}` } }
          },
          scales: {
            x: { stacked: true },
            y: { 
              stacked: true, 
              ticks: { 
                callback: value => 'AED ' + abbreviateNumber(value),
                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
              },
              grid: {
                color: document.body.classList.contains('dark-mode') ? '#4a5568' : '#dee2e6'
              }
            }
          }
        }
      });
    }

    function updateDeliveryTypes() {
      const internal = filteredData.reduce((sum, r) => sum + (r['Delivery CARD'] || 0) + (r['Delivery Cash'] || 0), 0);
      
      // All platform fields for third-party platforms
      const allPlatformFields = [
        'TALABAT', 'TABNA', 'Keeta CARD', 'NOON CARD', 
        'Master card', 'Visa Card', 'Careem CARD', 
        'SMILES CARD', 'DELIVERO CARD'
      ];
      
      const platforms = filteredData.reduce((sum, r) => {
        return sum + allPlatformFields.reduce((platformSum, field) => {
          return platformSum + (r[field] || 0);
        }, 0);
      }, 0);
      
      const total = internal + platforms;

      if (charts.deliveryTypes) charts.deliveryTypes.destroy();
      charts.deliveryTypes = new Chart(document.getElementById('deliveryTypesChart'), {
        type: 'doughnut',
        data: {
          labels: ['Internal Delivery', 'Third-Party Platforms'],
          datasets: [{
            data: [internal, platforms],
            backgroundColor: ['#2a9d8f', '#e63946'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.parsed)}` } }
          }
        }
      });

      const tbody = document.querySelector('#deliveryTypesTable tbody');
      tbody.innerHTML = `
        <tr><td>Internal</td><td>${formatCurrency(internal)}</td><td>${total > 0 ? (internal / total * 100).toFixed(1) : 0}%</td></tr>
        <tr><td>Third-Party</td><td>${formatCurrency(platforms)}</td><td>${total > 0 ? (platforms / total * 100).toFixed(1) : 0}%</td></tr>
      `;
    }

    function updateMonthlyTrends() {
      const monthlyData = {};
      filteredData.forEach(r => {
        const key = `${r.Year}-${String(r.Month).padStart(2, '0')}`;
        if (!monthlyData[key]) monthlyData[key] = { sales: 0, internal: 0, platforms: 0 };
        monthlyData[key].sales += r.Receipts || 0;
        monthlyData[key].internal += (r['Delivery CARD'] || 0) + (r['Delivery Cash'] || 0);
        
        // All platform fields for third-party platforms
        const allPlatformFields = [
          'TALABAT', 'TABNA', 'Keeta CARD', 'NOON CARD', 
          'Master card', 'Visa Card', 'Careem CARD', 
          'SMILES CARD', 'DELIVERO CARD'
        ];
        
        monthlyData[key].platforms += allPlatformFields.reduce((sum, field) => {
          return sum + (r[field] || 0);
        }, 0);
      });

      const sorted = Object.keys(monthlyData).sort();
      const labels = sorted.map(k => {
        const [y, m] = k.split('-');
        return new Date(y, m-1, 1).toLocaleString('default', { month: 'short', year: 'numeric' });
      });
      const sales = sorted.map(k => monthlyData[k].sales);
      const internal = sorted.map(k => monthlyData[k].internal);
      const platforms = sorted.map(k => monthlyData[k].platforms);

      if (charts.monthlyTrends) charts.monthlyTrends.destroy();
      charts.monthlyTrends = new Chart(document.getElementById('monthlyTrendsChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            { label: 'Total Sales', data: sales, borderColor: '#1d3557', backgroundColor: 'rgba(29, 53, 87, 0.1)', tension: 0.3 },
            { label: 'Internal Delivery', data: internal, borderColor: '#2a9d8f', backgroundColor: 'rgba(42, 157, 143, 0.1)', tension: 0.3 },
            { label: 'Third-Party', data: platforms, borderColor: '#e63946', backgroundColor: 'rgba(230, 57, 70, 0.1)', tension: 0.3 }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}` } }
          },
          scales: {
            y: { 
              ticks: { 
                callback: value => 'AED ' + abbreviateNumber(value),
                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
              },
              grid: {
                color: document.body.classList.contains('dark-mode') ? '#4a5568' : '#dee2e6'
              }
            }
          }
        }
      });
    }

    function updateInternalTrends() {
      const branches = [...new Set(filteredData.map(r => r.Branch))];
      const monthlyData = {};

      filteredData.forEach(r => {
        const key = `${r.Year}-${String(r.Month).padStart(2, '0')}`;
        if (!monthlyData[key]) monthlyData[key] = {};
        if (!monthlyData[key][r.Branch]) monthlyData[key][r.Branch] = 0;
        monthlyData[key][r.Branch] += (r['Delivery CARD'] || 0) + (r['Delivery Cash'] || 0);
      });

      const sorted = Object.keys(monthlyData).sort();
      const labels = sorted.map(k => {
        const [y, m] = k.split('-');
        return new Date(y, m-1, 1).toLocaleString('default', { month: 'short', year: 'numeric' });
      });

      const datasets = branches.map((branch, i) => {
        const color = `hsl(${i * 360 / branches.length}, 70%, 50%)`;
        return {
          label: branch.replace('Crispy Chicken', '').trim() || 'Main',
          data: sorted.map(k => monthlyData[k][branch] || 0),
          borderColor: color,
          backgroundColor: color + '20',
          tension: 0.3,
          fill: false
        };
      });

      if (charts.internalTrends) charts.internalTrends.destroy();
      charts.internalTrends = new Chart(document.getElementById('internalTrendsChart'), {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right', maxWidth: 200 },
            tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}` } }
          },
          scales: {
            y: { 
              ticks: { 
                callback: value => 'AED ' + abbreviateNumber(value),
                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
              },
              grid: {
                color: document.body.classList.contains('dark-mode') ? '#4a5568' : '#dee2e6'
              }
            }
          }
        }
      });
    }

    // Utility functions
    function formatCurrency(value) {
      return new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED', minimumFractionDigits: 0 }).format(value);
    }

    function abbreviateNumber(value) {
      if (value >= 1e6) return (value / 1e6).toFixed(1) + 'M';
      if (value >= 1e3) return (value / 1e3).toFixed(1) + 'K';
      return value.toFixed(0);
    }

    function showLoading(msg) {
      document.getElementById('loadingMessage').innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${msg}`;
      document.getElementById('loadingMessage').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loadingMessage').style.display = 'none';
    }

    function showError(msg) {
      document.getElementById('errorMessage').textContent = msg;
      document.getElementById('errorMessage').style.display = 'block';
      setTimeout(() => document.getElementById('errorMessage').style.display = 'none', 5000);
    }

    function downloadTemplate() {
      const csv = sampleData.map(row => row.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Sales_Data_Template.xlsx';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
